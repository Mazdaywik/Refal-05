# История изменений - Refal-05-Unicode

## [1.0.0-unicode] - 2025-01-07

### Добавлено
- Полная поддержка Unicode с использованием ICU (International Components for Unicode)
- Внутреннее представление символов UTF-32 для эффективной обработки
- Кодировка UTF-8 для всех операций ввода/вывода
- Сопоставление с образцом с учётом Unicode для всех типов символов
- Расширенная структура узлов с типом `R05_DATATAG_UNICODE`
- Новая библиотека Unicode (`r05-unicode.h/c`) с полным API
- Оптимизация ASCII - символы < 128 используют устаревшие узлы CHAR
- Поддержка всех письменностей Unicode, включая эмодзи

### Улучшенные встроенные функции
- `Chr` - Расширена для поддержки кодовых точек Unicode до U+10FFFF
- `Ord` - Возвращает кодовые точки Unicode для всех символов
- `ChrHex` - Преобразует шестнадцатеричную строку в символ Unicode (например, '0x4E2D' → '中')
- `OrdHex` - Преобразует символ в шестнадцатеричную строку (например, '中' → '0x4E2D')
- `Type` - Определение категории Unicode (Letter, Digit и т.д.)
- `Upper` - Полное преобразование в верхний регистр Unicode
- `Lower` - Полное преобразование в нижний регистр Unicode
- `Prout`/`Print` - Вывод UTF-8 с правильной кодировкой

### Возможности Unicode через ICU
- Запросы свойств символов (буквенный, цифровой, пробельный и т.д.)
- Преобразование регистра с поддержкой локали
- Нормализация Unicode (NFC, NFD, NFKC, NFKD)
- Идентификация письменности (латиница, кириллица, китайская и т.д.)
- Определение границ графемных кластеров
- Свойства двунаправленного текста

### Детали реализации
- Изменён `refal05rts.h` для добавления типа узла Unicode
- Обновлён `refal05rts.c` с выделением памяти и сравнением Unicode
- Улучшен `Library.c` со встроенными функциями с учётом Unicode
- Добавлено определение ICU в систему сборки (`c-plus-plus.conf.sh`)
- Создан полный набор тестов для функциональности Unicode

### Производительность
- Быстрый путь для символов ASCII в декодировании UTF-8
- Минимальные накладные расходы для программ только с ASCII
- Кэширование свойств символов в ICU

### Совместимость
- Полная обратная совместимость с существующими программами Refal-05
- Исходные файлы могут использовать кодировку UTF-8
- Двоичная совместимость сохранена при сборке без Unicode

### Требования к сборке
- Библиотеки разработки ICU (icu4c)
- Компилятор C с поддержкой C99
- Автоматическое определение доступности ICU

### Известные ограничения
- Сопоставление с образцом с комбинирующими символами требует осторожности
- Сортировка с учётом локали ещё не реализована

### Новые возможности (v1.1.0)
- **Шестнадцатеричные функции**: Добавлены `ChrHex` и `OrdHex` для шестнадцатеричных операций Unicode
  - `ChrHex` преобразует шестнадцатеричные строки (например, '0x4E2D') в символы Unicode
  - `OrdHex` преобразует символы в шестнадцатеричные строки (например, '中' → '0x4E2D')
- **Поддержка шестнадцатеричных литералов**: Парсер теперь распознаёт префикс `0x` для чисел
  - Прямая шестнадцатеричная запись в исходнике: `<Chr 0x4E2D>` эквивалентно `<Chr 20013>`
  - Работает во всех числовых контекстах: математические операции, сравнения и т.д.
- **Поддержка Unicode в компиляторе**: Компилятор пересобран со средой выполнения с поддержкой Unicode
  - Компилятор теперь правильно обрабатывает строки UTF-8 в исходных файлах
  - Исправлено Ord для возврата кодовых точек Unicode вместо байтов UTF-8

### Исправления ошибок
- Исправлены предупреждения совместимости ICU UTF-16 добавлением вспомогательных функций UTF-32 ↔ UTF-16
- Исправлено `Ord` возвращавшее последовательности байтов UTF-8 вместо кодовых точек Unicode
- Исправлено `OrdHex` для вывода правильных шестнадцатеричных строк (выводило десятичные)
- Исправлено `ChrHex` для правильного разбора шестнадцатеричных строк посимвольно
- Исправлен компилятор для использования `r05_alloc_utf8_string` для не-ASCII строк
- Добавлены функции Platform (PathSeparator, IsDirectorySeparator) в Library.c

### Тестирование
- `test-unicode-hello.ref` - Демонстрация на разных языках
- `test-simple-unicode.ref` - Операции с символами
- `test-unicode-compare.ref` - Тесты сопоставления с образцом
- `test-unicode-comprehensive.ref` - Нормализация, письменности, границы
- `test-unicode-advanced.ref` - Типы символов и смешанные строки
- `test-hex-literals.ref` - Разбор шестнадцатеричных литералов
- `test-hex-functions.ref` - Функциональность ChrHex/OrdHex
- `test-unicode-source.ref` - Unicode в исходном коде (демонстрирует ограничение)

### Авторы
Реализация Unicode: Данслав Славенской.

Refal-05: Александр Коновалов.